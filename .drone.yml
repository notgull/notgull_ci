kind: pipeline
type: docker
name: tidy

steps:
  - name: tidy
    image: notgull/ci:stable
    commands:
      - sh checks/tidy.sh
---
kind: pipeline
type: docker
name: publish

depends_on:
  - tidy

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: publish
    image: plugins/docker 
    settings:
      repo: notgull/ci
      tags: stable
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      dockerfile: docker/debian.Dockerfile
---
kind: pipeline
type: docker
name: github

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: mirror to GitHub
    image: alpine:edge
    environment:
      SSH_KEY:
        from_secret: gh_ssh_key
    commands:
      - apk add git openssh
      - mkdir -pv ~/.ssh
      - ssh-keyscan -H -t rsa github.com >> ~/.ssh/known_hosts
      - echo "$SSH_KEY" > ~/.ssh/id_rsa && chmod 0600 ~/.ssh/id_rsa
      - git remote add github_origin git@github.com:notgull/notgull_ci.git
      - git push github_origin main
